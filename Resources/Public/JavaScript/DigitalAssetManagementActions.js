/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["require","exports","jquery","moment","bootstrap"],function(e,t,a,s){"use strict";var i=function(){function e(){}return e.init=function(){var t=e;console.log("DigitalAssetManagement.init"),t.request("getContent",{path:""},t.genericRequestCallback),a(".digital-asset-management").on("click",".ajax-action",function(){var e=this.dataset.action,s={path:this.dataset.parameter,sort:t.settings.sort,reverse:t.settings.reverse};"selected"===this.dataset.parameter&&(s.path=[],a(".selected").each(function(e){console.log(this),s.path.push(this.dataset.parameter)})),console.log("ajax-action: "+e+", par: "+JSON.stringify(s)),t.request(e,s,t.genericRequestCallback)}),a(".digital-asset-management").on("click",".selectbox",function(e){return e.preventDefault(),a(this).parent(".selectable").toggleClass("selected"),t.selectFiles("selectionChanged"),!1}),a(".digital-asset-management").on("click",".view-action",function(){var e=this.dataset.action,t=this.dataset.parameter;console.log("view-action: "+e+", par: "+t),a(".maincontent").removeClass(function(e,t){return(t.match(/(^|\s)view-\S+/g)||[]).join(" ")}).addClass(e)}),a(".digital-asset-management").on("click",".sort-action",function(){var e=this.dataset.action,a={path:t.settings.path};console.log("sort-action"),t.sortAction(e,a)}),a(".digital-asset-management").on("click",".select-action",function(){var e=this.dataset.action;t.settings.path;console.log("local-action"),t.selectFiles(e)}),a("body").on("click",function(){a(".sidebar").addClass("hidden")})},e.renderError=function(e){a(".errorlog").html(e.responseText)},e.renderContent=function(t){var i=e;if(t&&t.request&&a(".errorlog").html(t.request+t.response),t.result&&(t.result.files||t.result.folder)){for(var r="",n=0;n<t.result.folders.length;n++){var l=t.result.folders[n];l.mimetype="folder",r+=i.replaceTemplateVars(i.folderPartial,l)}a(".folders").html(r),r="";for(n=0;n<t.result.files.length;n++){var o=t.result.files[n];o.mimetype=o.mimetype.replace("/"," "),o.modification_date_formated=s.unix(o.modification_date).format(top.TYPO3.settings.DateTimePicker.DateFormat[1]||"YYYY-MM-DD"),r+=i.replaceTemplateVars(i.filePartial,o)}a(".files").html(r)}},e.renderBreadcrumb=function(t){var s="",i=e,r="";if(t.result&&t.result.breadcrumbs){for(var n=0;n<t.result.breadcrumbs.length;n++){var l=t.result.breadcrumbs[n];"home"===l.type?l.label=TYPO3.lang["dam.labels.files"]:(l.label=l.name,r=l.identifier,s+="&nbsp;&gt;&nbsp;"),s+=i.replaceTemplateVars(i.breadcrumbPartial,l)}a('.ajax-action[data-action="reindexStorage"]').attr("data-parameter",r).removeClass("disabled"),s?a(".breadcrumb").html(s).removeClass("empty"):a(".breadcrumb").html("").addClass("empty"),t.result.files.length?a(".files").removeClass("empty"):a(".files").addClass("empty"),t.result.folders.length?a(".folders").removeClass("empty"):a(".folders").addClass("empty")}},e.loadThumbs=function(){var t=e;a(".grid.image").each(function(){var e=a(this).find("img").attr("data-src");e&&t.request("getThumbnail",{path:e},t.renderThumb)})},e.renderThumb=function(e){e.result&&e.result.thumbnail&&a(".grid.image").each(function(){var t=a(this).find("img");e.params.path===t.attr("data-src")&&(t.attr("src",e.result.thumbnail),a(this).find(".icon").addClass("small"))})},e.showMetadata=function(e){if(e.result&&e.result.file){var t='<h4>Metadata</h4>\n<dl class="row">\n';for(var s in console.log(e.result.file),e.result.file)e.result.file.hasOwnProperty(s)&&(t+='<dt class="col-sm-4">'+s+'</dt><dd class="col-sm-8">'+e.result.file[s]+"</dd>");t+="</dl>",a(".metadata").html(t),a(".sidebar").removeClass("hidden")}},e.request=function(t,s,i){var r=e,n={action:"",params:{}},l=!1;n.action=t,n.params=s,console.log(n),a.getJSON(TYPO3.settings.ajaxUrls.dam_request,n).done(function(e){i(e)}).fail(function(e){console.log("DigitalAssetManagement request promise fail "+JSON.stringify(e)),l||(top.TYPO3.Notification.warning("Request failed","Content can not be displayed. "+e.readyState),l=!0),r.renderError(e)})},e.genericRequestCallback=function(t){var s=e,i=t.action;switch(t.result&&t.result.settings&&(s.settings=t.result.settings),i){case"getContent":s.renderBreadcrumb(t),s.renderContent(t),s.loadThumbs(),a(".sort-order").removeClass("active"),s.settings.reverse?a('.sort-action[data-action="sort-order-dsc"]').addClass("active"):a('.sort-action[data-action="sort-order-asc"]').addClass("active"),a(".sort-field").removeClass("active"),"modified"===s.settings.sort?a('.sort-action[data-action="sort-by-date"]').addClass("active"):"name"===s.settings.sort?a('.sort-action[data-action="sort-by-name"]').addClass("active"):"size"===s.settings.sort&&a('.sort-action[data-action="sort-by-size"]').addClass("active");break;case"getThumbnail":s.renderThumb(t);break;case"getMetadata":s.showMetadata(t);break;default:top.TYPO3.Notification.warning("Request failed","Unknown action: "+i)}s.selectFiles("selectionChanged")},e.sortAction=function(t,s){var i=e;switch(console.log("sort-action: "+t+", par: "+JSON.stringify(s)),t){case"sort-order-asc":i.settings.reverse=!1;break;case"sort-order-dsc":i.settings.reverse=!0;break;case"sort-by-name":i.settings.sort="name";break;case"sort-by-size":i.settings.sort="size";break;case"sort-by-date":i.settings.sort="modified"}s.reverse=i.settings.reverse||!1,s.sort=i.settings.sort||"name",console.log("sort-action: "+t+", par: "+JSON.stringify(s)),a(".maincontent").removeClass(function(e,t){return(t.match(/(^|\s)sort-order-\S+/g)||[]).join(" ")}).addClass(t).attr("data-reverse",s.reverse),i.request("getContent",s,i.genericRequestCallback)},e.selectFiles=function(e){"deselectAll"===e&&a(".selectable").removeClass("selected"),a(".selectable.selected").length?(1===a(".selected").length?a(".filesselected").text(TYPO3.lang["dam.labels.nav.fileselected"]):a(".filesselected").text(a(".selected").length+" "+TYPO3.lang["dam.labels.nav.filesselected"]),a(".newaction").hide(),a(".fileaction").show()):(a(".newaction").show(),a(".fileaction").hide())},e.replaceTemplateVars=function(e,t){return e.replace(/{([:a-zA-Z_\.-]*)}/g,function(e,a){return 0===a.indexOf("lll:")?TYPO3.lang[a.replace(/lll:/,"")]||a:t.hasOwnProperty(a)?t[a]:"###missing prop:"+a+"#"})},e.folderPartial='    <div class="grid selectable ajax-action {mimetype}" data-action="getContent" data-parameter="{identifier}">\n   <div class="grid-cell" >\n      <div class="icon folder-icon {type}"></div>   </div>\n   <div class="info">\n      <div class="grid-cell filename"><h5 class="card-title">{name}</h5></div>\n   </div>\n  </div>\n',e.filePartial='<div class="grid file {mimetype} selectable ajax-action" data-action="getMetadata" data-parameter="{identifier}">\n    <div class="preview" ><img src="/typo3conf/ext/digital_asset_management/Resources/Public/Images/empty.png" data-src="{identifier}"></div>\n    <div class="grid-cell selectbox" >\n    </div>\n    <div class="grid-cell" >\n        <div class="icon icon-mimetypes-{mimetype}" /></div>\n    <div class="info">\n      <div class="grid-cell filename"><h5>{name}</h5></div>\n      <div class="grid-cell filesize"><p><span class="grid-label">{lll:dam.labels.filesize}: </span>{size}</p></div>\n      <div class="grid-cell moddate"><p><span class="grid-label">{lll:dam.labels.modified}: <n></n>\t\t</span>{modification_date_formated}</p></div>\n    </div>  </div>\n',e.breadcrumbPartial='<span class="ajax-action" data-action="getContent" data-parameter="{identifier}">{label}</span>',e.metadataPartial="",e}();return a(i.init),TYPO3.DigitalAssetManagementActions=i,i});
