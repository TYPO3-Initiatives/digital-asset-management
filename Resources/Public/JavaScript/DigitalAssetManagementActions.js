/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["require","exports","jquery","moment","bootstrap"],function(e,a,t,i){"use strict";var r=function(){function e(){}return e.init=function(){var a=e;console.log("DigitalAssetManagement.init"),a.request("getContent","",a.genericRequestCallback),t(".digital-asset-management").on("click",".ajax-action",function(){var e=this.dataset.method,t=this.dataset.parameter;console.log("method: "+e+", par: "+t),a.request(e,t,a.genericRequestCallback)}),t(".digital-asset-management").on("click",".view-action",function(){var e=this.dataset.action,a=this.dataset.parameter;console.log("action: "+e+", par: "+a),t(".maincontent").removeClass(function(e,a){return(a.match(/(^|\s)view-\S+/g)||[]).join(" ")}).addClass(e)})},e.renderError=function(e){t(".errorlog").html(e.responseText)},e.renderContent=function(a){var r=e;if(a&&a.request&&t(".errorlog").html(a.request+a.response),a.result&&(a.result.files||a.result.folder)){for(var l="",s=0;s<a.result.folders.length;s++){var n=a.result.folders[s];n.mimetype="folder",l+=r.replaceTemplateVars(r.folderPartial,n)}t(".folders").html(l),l="";for(s=0;s<a.result.files.length;s++){var d=a.result.files[s];d.mimetype=d.mimetype.replace("/"," "),d.modification_date_formated=i.unix(d.modification_date).format(top.TYPO3.settings.DateTimePicker.DateFormat[1]||"YYYY-MM-DD"),l+=r.replaceTemplateVars(r.filePartial,d)}t(".files").html(l)}},e.renderBreadcrumb=function(a){var i="",r=e,l="";if(a.result&&a.result.breadcrumbs){for(var s=0;s<a.result.breadcrumbs.length;s++){var n=a.result.breadcrumbs[s];"home"===n.type?n.label=TYPO3.lang["dam.labels.files"]:(n.label=n.name,l=n.identifier,i+="&nbsp;&gt;&nbsp;"),i+=r.replaceTemplateVars(r.breadcrumbPartial,n)}t('.ajax-action[data-action="reindexStorage"]').attr("data-parameter",l).removeClass("disabled"),i?t(".breadcrumb").html(i).removeClass("empty"):t(".breadcrumb").html("").addClass("empty"),a.result.files.length?t(".files").removeClass("empty"):t(".files").addClass("empty"),a.result.folders.length?t(".folders").removeClass("empty"):t(".folders").addClass("empty")}},e.loadThumbs=function(){var a=e;t(".grid.image").each(function(e,i){var r=t(this).find("img").attr("data-src");r&&a.request("getThumbnail",r,a.renderThumb)})},e.renderThumb=function(e){e.result&&e.result.thumbnail&&t(".grid.image").each(function(a,i){var r=t(this).find("img");e.params===r.attr("data-src")&&(r.attr("src",e.result.thumbnail),t(this).find(".icon").addClass("small"))})},e.showMetadata=function(e){if(e.result&&e.result.file){for(var a in console.log(e.result.file),e.result.file)console.log(a);t(".metadata").html(JSON.stringify(e.result.file)).show(),t(".grid.image").each(function(a,i){var r=t(this).find("img");e.params===r.attr("data-src")&&(r.attr("src",e.result.thumbnail),t(this).find(".icon").addClass("small"))})}},e.request=function(a,i,r){var l=e,s={},n=!1;s.method=a,s.params=i,t.getJSON(TYPO3.settings.ajaxUrls.dam_request,s).done(function(e){r(e)}).fail(function(e){console.log("DigitalAssetManagement request promise fail "+JSON.stringify(e)),n||(top.TYPO3.Notification.warning("Request failed","Content can not be displayed. "+e.readyState),n=!0),l.renderError(e)})},e.genericRequestCallback=function(a){var t=e,i=a.method;switch(i){case"getContent":t.renderBreadcrumb(a),t.renderContent(a),t.loadThumbs();break;case"getThumbnail":t.renderThumb(a);break;case"getMetadata":t.showMetadata(a);break;default:top.TYPO3.Notification.warning("Request failed","Unknown method: "+i)}},e.replaceTemplateVars=function(e,a){return e.replace(/{([:a-zA-Z_\.-]*)}/g,function(e,t){return 0===t.indexOf("lll:")?TYPO3.lang[t.replace(/lll:/,"")]||t:a.hasOwnProperty(t)?a[t]:"###missing prop:"+t+"#"})},e.folderPartial='    <div class="grid ajax-action {mimetype}" data-action="getContent" data-parameter="{identifier}">\n   <div class="grid-cell" >\n      <div class="icon folder-icon {type}"></div>   </div>\n   <div class="info">\n      <div class="grid-cell filename"><h5 class="card-title">{name}</h5></div>\n   </div>\n  </div>\n',e.filePartial='<div class="grid file {mimetype} ajax-action" data-action="getMetadata" data-parameter="{identifier}">\n    <div class="preview" ><img src="/typo3conf/ext/digital_asset_management/Resources/Public/Images/empty.png" data-src="{identifier}"></div>\n    <div class="grid-cell" >\n        <div class="icon icon-mimetypes-{mimetype}" /></div>\n    <div class="info">\n      <div class="grid-cell filename"><h5>{name}</h5></div>\n      <div class="grid-cell filesize"><p><span class="grid-label">{lll:dam.labels.filesize}: </span>{size}</p></div>\n      <div class="grid-cell moddate"><p><span class="grid-label">{lll:dam.labels.modified}: <n></n>\t\t</span>{modification_date_formated}</p></div>\n    </div>  </div>\n',e.breadcrumbPartial='<span class="ajax-action" data-action="getContent" data-parameter="{identifier}">{label}</span>',e}();return t(r.init),TYPO3.DigitalAssetManagementActions=r,r});