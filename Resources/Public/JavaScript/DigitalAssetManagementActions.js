/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["require","exports","jquery","moment","TYPO3/CMS/Backend/Notification","TYPO3/CMS/Backend/DragUploader","bootstrap"],function(e,t,a,s,r,i){"use strict";var n=function(){function e(){}return e.init=function(){var t=e,s=a(".digital-asset-management"),r=a("body");console.log("DigitalAssetManagement.init"),t.request("getContent",{path:""},t.genericRequestCallback),s.on("click",".ajax-action",function(){var e=this.dataset.action,s={path:this.dataset.parameter,sort:t.settings.sort,reverse:t.settings.reverse};"selected"===this.dataset.parameter&&(s.path=[],a(".selected").each(function(e){console.log(this),s.path.push(this.dataset.parameter)})),console.log("ajax-action: "+e+", par: "+JSON.stringify(s)),t.request(e,s,t.genericRequestCallback)}),s.on("click",".selectbox",function(e){return e.preventDefault(),a(this).parent(".selectable").toggleClass("selected"),t.selectFiles("selectionChanged"),!1}),s.on("click",".view-action",function(){var e=this.dataset.action,a=this.dataset.parameter;console.log("view-action: "+e+", par: "+a),t.viewAction(e)}),s.on("click",".sort-action",function(){var e=this.dataset.action,a={path:t.settings.path};console.log("sort-action"),t.sortAction(e,a)}),s.on("click",".select-action",function(){var e=this.dataset.action;t.settings.path;console.log("select-action"),t.selectFiles(e)}),r.on("click",function(){a(".sidebar").addClass("hidden")}),a(".dropzone-close").on("click",function(e){console.dir(i),i.hideDropzone(e)}),i.initialize(".dropzone"),a(".localize").each(function(e){var t=a(this).attr("data-l10nkey");TYPO3.lang[t]?a(this).text(TYPO3.lang[t]):a(this).text("## localization missing: "+t)})},e.renderError=function(e){a(".errorlog").html(e.responseText)},e.renderContent=function(t){var r=e;if(t&&t.request&&a(".errorlog").html(t.request+t.response),t.result&&(t.result.files||t.result.folder)){for(var i="",n=0;n<t.result.folders.length;n++){var o=t.result.folders[n];o.mimetype="folder",i+=r.replaceTemplateVars(r.folderPartial,o)}a(".folders").html(i),i="";for(n=0;n<t.result.files.length;n++){var l=t.result.files[n];l.mimetype=l.mimetype.replace("/"," "),l.modification_date_formated=s.unix(l.modification_date).format(top.TYPO3.settings.DateTimePicker.DateFormat[1]||"YYYY-MM-DD"),i+=r.replaceTemplateVars(r.filePartial,l)}a(".files").html(i)}},e.renderBreadcrumb=function(t){var s="",r=e,i="";if(t.result&&t.result.breadcrumbs){for(var n=0;n<t.result.breadcrumbs.length;n++){var o=t.result.breadcrumbs[n];"home"===o.type?o.label=TYPO3.lang["dam.labels.files"]:(o.label=o.name,i=o.identifier,s+="&nbsp;&gt;&nbsp;"),s+=r.replaceTemplateVars(r.breadcrumbPartial,o)}a('.ajax-action[data-action="reindexStorage"]').attr("data-parameter",i).removeClass("disabled"),s?a(".breadcrumb").html(s).removeClass("empty"):a(".breadcrumb").html("").addClass("empty"),t.result.files.length?a(".files").removeClass("empty"):a(".files").addClass("empty"),t.result.folders.length?a(".folders").removeClass("empty"):a(".folders").addClass("empty")}},e.loadThumbs=function(){var t=e;a(".grid.image").each(function(){var e=a(this).find("img").attr("data-src");e&&t.request("getThumbnail",{path:e},t.renderThumb)})},e.renderThumb=function(e){e.result&&e.result.thumbnail&&(console.log("got thumbs"),console.log(e),a(".grid.image").each(function(){var t=a(this).find("img");e.params.path===t.attr("data-src")&&(t.attr("src",e.result.thumbnail),a(this).find(".icon").addClass("small"))}))},e.showMetadata=function(e){if(e.result&&e.result.file){var t='<h4>Metadata</h4>\n<dl class="row">\n';for(var s in console.log(e.result.file),e.result.file)e.result.file.hasOwnProperty(s)&&(t+='<dt class="col-sm-4">'+s+'</dt><dd class="col-sm-8">'+e.result.file[s]+"</dd>");t+="</dl>",a(".metadata").html(t),a(".sidebar").removeClass("hidden")}},e.request=function(t,s,i){var n=e,o={action:"",params:{}},l=!1;o.action=t,o.params=s,console.log(o),a.getJSON(TYPO3.settings.ajaxUrls.dam_request,o).done(function(e){i(e)}).fail(function(e){console.log("DigitalAssetManagement request promise fail "+JSON.stringify(e)),l||(r.warning("Request failed","Content can not be displayed. "+e.readyState),l=!0),n.renderError(e)})},e.genericRequestCallback=function(t){var s=e,i=t.action;switch(t.result&&t.result.settings&&(s.settings=t.result.settings),i){case"getContent":console.log(t),s.renderBreadcrumb(t),s.renderContent(t),s.loadThumbs(),t.result.current&&t.result.current.identifier&&(a(".breadcrumb").attr("data-identifier",t.result.current.identifier),a(".t3js-drag-uploader").attr("data-target-folder",t.result.current.identifier)),a(".sort-order").removeClass("active"),s.settings.reverse?a('.sort-action[data-action="sort-order-dsc"]').addClass("active"):a('.sort-action[data-action="sort-order-asc"]').addClass("active"),a(".sort-action").removeClass("active"),"modified"===s.settings.sort?a('.sort-action[data-action="sort-by-date"]').addClass("active"):"name"===s.settings.sort?a('.sort-action[data-action="sort-by-name"]').addClass("active"):"size"===s.settings.sort&&a('.sort-action[data-action="sort-by-size"]').addClass("active");break;case"getThumbnail":s.renderThumb(t);break;case"getMetadata":s.showMetadata(t);break;default:r.warning("Request failed","Unknown action: "+i)}s.selectFiles("selectionChanged")},e.viewAction=function(e){switch(e){case"upload":i.showDropzone();break;case"showUploadProgress":a(".upload-progress").removeClass("hidden");break;default:a(".maincontent").removeClass(function(e,t){return(t.match(/(^|\s)view-\S+/g)||[]).join(" ")}).addClass(e)}},e.sortAction=function(t,s){var r=e;switch(console.log("sort-action: "+t+", par: "+JSON.stringify(s)),t){case"sort-order-asc":r.settings.reverse=!1;break;case"sort-order-dsc":r.settings.reverse=!0;break;case"sort-by-name":r.settings.sort="name",r.settings.reverse=!r.settings.reverse;break;case"sort-by-size":r.settings.sort="size",r.settings.reverse=!r.settings.reverse;break;case"sort-by-date":r.settings.sort="modified",r.settings.reverse=!r.settings.reverse}s.reverse=r.settings.reverse,s.sort=r.settings.sort,console.log("sort-action: "+t+", par: "+JSON.stringify(s)),a(".maincontent").removeClass(function(e,t){return(t.match(/(^|\s)sort-order-\S+/g)||[]).join(" ")}).addClass(t).attr("data-reverse",s.reverse),a(".sort-action").removeClass("sort-order-asc sort-order-dsc"),a('.sort-action[data-action="'+t+'"]').addClass(s.reverse?"sort-order-dsc":"sort-order-asc"),r.request("getContent",s,r.genericRequestCallback)},e.selectFiles=function(e){"deselectAll"===e&&a(".selectable").removeClass("selected"),a(".selectable.selected").length?(1===a(".selected").length?a(".filesselected").text(TYPO3.lang["dam.labels.nav.fileselected"]):a(".filesselected").text(a(".selected").length+" "+TYPO3.lang["dam.labels.nav.filesselected"]),a(".newaction").hide(),a(".fileaction").show()):(a(".newaction").show(),a(".fileaction").hide())},e.initDropzone=function(){var t=e,s=a(".dropzone");a("body").on("dragenter",function(e){e.preventDefault(),e.stopPropagation(),s.removeClass("hidden")}),s.on("dragenter",function(e){e.preventDefault(),e.stopPropagation()}),s.on("dragleave",function(e){e.preventDefault(),e.stopPropagation(),s.addClass("hidden")}),s.on("dragover",function(e){e.preventDefault(),e.stopPropagation(),e.originalEvent.dataTransfer.dropEffect="copy"}),s.on("drop",function(e){console.dir(e),e.originalEvent.dataTransfer&&e.originalEvent.dataTransfer.files.length&&(e.preventDefault(),e.stopPropagation(),console.dir(e.originalEvent.dataTransfer.files),t.showFilesToUpload(".sidebar",e.originalEvent.dataTransfer.files),s.addClass("hidden"),t.uploadFiles(e.originalEvent.dataTransfer.files))}),s.on("click",function(){a(this).addClass("hidden")}),a("input[type=file]").on("change",function(e){console.log("upload files from file dialog to server"),console.dir(e),console.log(a(this).val()),console.dir(e.originalEvent.target.files)})},e.showFilesToUpload=function(e,t){var s=a(e);if(s.removeClass("hidden"),t){var r=[];r.push('<h4>Files</h4>\n<dl class="row">\n');for(var i=0,n=void 0;n=t[i];i++)r.push('<dt id="file'+i+'" class="col-sm-4">'+n.name+'</dt><dd class="col-sm-8">('+n.type||"n/a) - "+n.size+" bytes</dd>");r.push("</dl>"),a(".metadata").html(r.join("")),s.removeClass("hidden")}},e.uploadFiles=function(t){var s=e;if(t){console.log("to upload:"),a(".upload-in-progress-info").removeClass("hidden");a(".breadcrumb").attr("data-identifier");for(var i=0,n=void 0;n=t[i];i++){var o=new FormData;o.append("file",n,n.name),o.append("overwriteExistingFiles","cancel"),console.log(t),a.ajax(TYPO3.settings.ajaxUrls.file_process,{datatype:"json",cache:!1,contentType:!1,processData:!1,data:o,type:"post"}).done(function(e){console.log("uploaded!!!!"),a(".upload-in-progress-info").addClass("hidden"),console.dir(e)}).fail(function(e){console.log("DigitalAssetManagement upload files ajax call fails "+JSON.stringify(e)),r.warning("Request failed","Error uploading files. "+e.readyState),s.renderError(e)})}}},e.replaceTemplateVars=function(e,t){return e.replace(/{([:a-zA-Z_\.-]*)}/g,function(e,a){return 0===a.indexOf("lll:")?TYPO3.lang[a.replace(/lll:/,"")]||a:t.hasOwnProperty(a)?t[a]:"###missing prop:"+a+"#"})},e.folderPartial='    <div class="grid selectable ajax-action {mimetype}" data-action="getContent" data-parameter="{identifier}">\n   <div class="grid-cell" >\n      <div class="icon folder-icon {type}"></div>   </div>\n   <div class="info">\n      <div class="grid-cell filename"><h5 class="card-title" data-field="name" data-escape="false">{name}</h5></div>\n   </div>\n  </div>\n',e.filePartial='<div class="grid file {mimetype} selectable ajax-action" data-action="getMetadata" data-parameter="{identifier}">\n    <div class="preview" ><img src="/typo3conf/ext/digital_asset_management/Resources/Public/Images/empty.png" data-src="{identifier}"></div>\n    <div class="grid-cell selectbox" >\n    </div>\n    <div class="grid-cell" >\n        <div class="icon icon-mimetypes-{mimetype}" /></div>\n    <div class="info">\n      <div class="grid-cell filename"><h5>{name}</h5></div>\n      <div class="grid-cell filesize"><p><span class="grid-label">{lll:dam.labels.filesize}: </span>{size}</p></div>\n      <div class="grid-cell moddate"><p><span class="grid-label">{lll:dam.labels.modified}: <n></n>\t\t</span>{modification_date_formated}</p></div>\n    </div>  </div>\n',e.breadcrumbPartial='<li class="breadcrumb-item ajax-action" data-action="getContent" data-parameter="{identifier}">{label}</li>',e.metadataPartial="",e}();return a(n.init),"undefined"!=typeof TYPO3&&(TYPO3.DigitalAssetManagementActions=n),n});