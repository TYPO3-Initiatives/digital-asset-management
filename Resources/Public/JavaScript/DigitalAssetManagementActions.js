/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["require","exports","jquery","moment","bootstrap"],function(e,t,a,s){"use strict";var r=function(){function e(){}return e.init=function(){var t=e;console.log("DigitalAssetManagement.init"),t.request("getContent",{path:""},t.genericRequestCallback),a(".digital-asset-management").on("click",".ajax-action",function(){var e=this.dataset.action,a={path:this.dataset.parameter,sort:t.settings.sort,reverse:t.settings.reverse};console.log("ajax-action: "+e+", par: "+JSON.stringify(a)),t.request(e,a,t.genericRequestCallback)}),a(".digital-asset-management").on("click",".view-action",function(){var e=this.dataset.action,t=this.dataset.parameter;console.log("view-action: "+e+", par: "+t),a(".maincontent").removeClass(function(e,t){return(t.match(/(^|\s)view-\S+/g)||[]).join(" ")}).addClass(e)}),a(".digital-asset-management").on("click",".sort-action",function(){var e=this.dataset.action,a={path:t.settings.path};console.log("sort-action"),t.sortAction(e,a)}),a("body").on("click",function(){a(".sidebar").addClass("hidden")})},e.renderError=function(e){a(".errorlog").html(e.responseText)},e.renderContent=function(t){var r=e;if(t&&t.request&&a(".errorlog").html(t.request+t.response),t.result&&(t.result.files||t.result.folder)){for(var i="",n=0;n<t.result.folders.length;n++){var o=t.result.folders[n];o.mimetype="folder",i+=r.replaceTemplateVars(r.folderPartial,o)}a(".folders").html(i),i="";for(n=0;n<t.result.files.length;n++){var l=t.result.files[n];l.mimetype=l.mimetype.replace("/"," "),l.modification_date_formated=s.unix(l.modification_date).format(top.TYPO3.settings.DateTimePicker.DateFormat[1]||"YYYY-MM-DD"),i+=r.replaceTemplateVars(r.filePartial,l)}a(".files").html(i)}},e.renderBreadcrumb=function(t){var s="",r=e,i="";if(t.result&&t.result.breadcrumbs){for(var n=0;n<t.result.breadcrumbs.length;n++){var o=t.result.breadcrumbs[n];"home"===o.type?o.label=TYPO3.lang["dam.labels.files"]:(o.label=o.name,i=o.identifier,s+="&nbsp;&gt;&nbsp;"),s+=r.replaceTemplateVars(r.breadcrumbPartial,o)}a('.ajax-action[data-action="reindexStorage"]').attr("data-parameter",i).removeClass("disabled"),s?a(".breadcrumb").html(s).removeClass("empty"):a(".breadcrumb").html("").addClass("empty"),t.result.files.length?a(".files").removeClass("empty"):a(".files").addClass("empty"),t.result.folders.length?a(".folders").removeClass("empty"):a(".folders").addClass("empty")}},e.loadThumbs=function(){var t=e;a(".grid.image").each(function(){var e=a(this).find("img").attr("data-src");e&&t.request("getThumbnail",{path:e},t.renderThumb)})},e.renderThumb=function(e){e.result&&e.result.thumbnail&&a(".grid.image").each(function(){var t=a(this).find("img");e.params.path===t.attr("data-src")&&(t.attr("src",e.result.thumbnail),a(this).find(".icon").addClass("small"))})},e.showMetadata=function(e){if(e.result&&e.result.file){var t='<h4>Metadata</h4>\n<dl class="row">\n';for(var s in console.log(e.result.file),e.result.file)e.result.file.hasOwnProperty(s)&&(t+='<dt class="col-sm-4">'+s+'</dt><dd class="col-sm-8">'+e.result.file[s]+"</dd>");t+="</dl>",a(".metadata").html(t),a(".sidebar").removeClass("hidden")}},e.request=function(t,s,r){var i=e,n={action:"",params:{}},o=!1;n.action=t,n.params=s,console.log(n),a.getJSON(TYPO3.settings.ajaxUrls.dam_request,n).done(function(e){r(e)}).fail(function(e){console.log("DigitalAssetManagement request promise fail "+JSON.stringify(e)),o||(top.TYPO3.Notification.warning("Request failed","Content can not be displayed. "+e.readyState),o=!0),i.renderError(e)})},e.genericRequestCallback=function(t){var s=e,r=t.action;switch(t.result.settings&&(s.settings=t.result.settings),r){case"getContent":s.renderBreadcrumb(t),s.renderContent(t),s.loadThumbs(),s.settings.reverse?(a('.sort-action[data-action="sort-order-asc"]').removeClass("active"),a('.sort-action[data-action="sort-order-dsc"]').addClass("active")):(a('.sort-action[data-action="sort-order-asc"]').addClass("active"),a('.sort-action[data-action="sort-order-dsc"]').removeClass("active")),"date"===s.settings.sort?(a('.sort-action[data-action="sort-by-name"]').removeClass("active"),a('.sort-action[data-action="sort-by-date"]').addClass("active")):(a('.sort-action[data-action="sort-by-name"]').addClass("active"),a('.sort-action[data-action="sort-by-date"]').removeClass("active"));break;case"getThumbnail":s.renderThumb(t);break;case"getMetadata":s.showMetadata(t);break;default:top.TYPO3.Notification.warning("Request failed","Unknown action: "+r)}},e.sortAction=function(t,s){var r=e;switch(console.log("sort-action: "+t+", par: "+JSON.stringify(s)),t){case"sort-order-asc":r.settings.reverse=!1;break;case"sort-order-dsc":r.settings.reverse=!0;break;case"sort-by-name":r.settings.sort="name";break;case"sort-by-date":r.settings.sort="date"}s.reverse=r.settings.reverse||!1,s.sort=r.settings.sort||"name",a(".maincontent").removeClass(function(e,t){return(t.match(/(^|\s)sort-order-\S+/g)||[]).join(" ")}).addClass(t).attr("data-reverse",s.reverse),r.request("getContent",s,r.genericRequestCallback)},e.replaceTemplateVars=function(e,t){return e.replace(/{([:a-zA-Z_\.-]*)}/g,function(e,a){return 0===a.indexOf("lll:")?TYPO3.lang[a.replace(/lll:/,"")]||a:t.hasOwnProperty(a)?t[a]:"###missing prop:"+a+"#"})},e.folderPartial='    <div class="grid ajax-action {mimetype}" data-action="getContent" data-parameter="{identifier}">\n   <div class="grid-cell" >\n      <div class="icon folder-icon {type}"></div>   </div>\n   <div class="info">\n      <div class="grid-cell filename"><h5 class="card-title">{name}</h5></div>\n   </div>\n  </div>\n',e.filePartial='<div class="grid file {mimetype} ajax-action" data-action="getMetadata" data-parameter="{identifier}">\n    <div class="preview" ><img src="/typo3conf/ext/digital_asset_management/Resources/Public/Images/empty.png" data-src="{identifier}"></div>\n    <div class="grid-cell" >\n        <div class="icon icon-mimetypes-{mimetype}" /></div>\n    <div class="info">\n      <div class="grid-cell filename"><h5>{name}</h5></div>\n      <div class="grid-cell filesize"><p><span class="grid-label">{lll:dam.labels.filesize}: </span>{size}</p></div>\n      <div class="grid-cell moddate"><p><span class="grid-label">{lll:dam.labels.modified}: <n></n>\t\t</span>{modification_date_formated}</p></div>\n    </div>  </div>\n',e.breadcrumbPartial='<span class="ajax-action" data-action="getContent" data-parameter="{identifier}">{label}</span>',e.metadataPartial="",e}();return a(r.init),TYPO3.DigitalAssetManagementActions=r,r});